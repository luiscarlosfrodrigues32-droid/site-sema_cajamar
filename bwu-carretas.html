
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle Instala√ß√£o/Remo√ß√£o - BWU e Carretas (Usu√°rios & Log)</title>
  <style>
   :root{
    --c1:#1f6feb;
    --c2:#0ea5e9;

    /* TEMA CLARO (mantido) */
    --bg:#f4f6f8;
    --card:#ffffff;
    --muted:#6b7280;
    --border:#d0d5dc;
    --ink:#1f2937;

    --ok:#22c55e;
    --warn:#f59e0b;
    --danger:#ef4444;

    /* NOVO: tipografia fluida (clamp) */
    --fs-1: clamp(18px, 1.2vw + 12px, 22px);   /* h3 / bot√µes maiores */
    --fs-2: clamp(16px, 1vw + 10px, 20px);     /* corpo padr√£o */
    --fs-3: clamp(14px, 0.8vw + 9px, 18px);    /* r√≥tulos/ajuda */
  }

  *{ box-sizing:border-box; }
  html, body{ height:100%; }
  body{
    margin:0; padding:0;
    background:var(--bg);
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    font-size: var(--fs-2);         /* NOVO: tamanho base fluido */
    line-height: 1.4;
  }

  .container{
    max-width:1200px;
    margin:0 auto;
    padding: 16px 16px;             /* NOVO: padding reduzido em mobile */
  }

  /* TOP BAR */
  .topbar{
    background:#ffffff;
    border-bottom:1px solid var(--border);
    padding:10px 12px;
    display:flex; align-items:center; justify-content:space-between;
    position:sticky; top:0; z-index:10;
    box-shadow:0 2px 5px rgba(0,0,0,0.05);
    gap: 8px;                       /* NOVO */
  }

  .brand{ display:flex; gap:10px; align-items:center; font-weight:700; color:#374151; }
  .brand > span { font-size: var(--fs-1); }    /* NOVO: t√≠tulo com clamp */

  .brand .tag{
    font-size:.80rem;
    background:#e5e7eb; color:#374151; padding:3px 8px; border-radius:6px;
    white-space: nowrap;
  }

  .userbox{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; } /* NOVO: wrap em telas pequenas */
  .role-badge{ padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:#e5e7eb; color:#374151; font-size:.8rem; }

  .btn{
    padding:10px 14px;               /* NOVO: toque maior */
    border-radius:10px;
    border:1px solid var(--border);
    background:#ffffff; color:var(--ink);
    cursor:pointer; transition:0.2s;
    font-size: var(--fs-2);          /* fluido */
  }
  .btn:hover{ background:#f0f2f5; }
  .btn.primary{ background:var(--c1); border:none; color:white; }
  .btn.success{ background:var(--ok); border:none; color:white; }
  .btn.warn{ background:var(--warn); border:none; color:white; }
  .btn.danger{ background:var(--danger); border:none; color:white; }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }

  .nav{ display:flex; gap:8px; flex-wrap:wrap; } /* NOVO: wrap */
  .sep{ width:1px; background:var(--border); height:26px; }

  h1,h2,h3{ margin:0 0 12px; color:#1f2937; }
  h2{ font-size: calc(var(--fs-1) + 2px); }
  h3{ font-size: var(--fs-1); }

  .action-buttons{ display:flex; gap:12px; flex-wrap:wrap; margin:12px 0 24px; }
  .btn-action{
    background: var(--c1); color:white; border:none;
    padding:12px 16px; border-radius:10px; cursor:pointer; font-weight:600;
    box-shadow:0 4px 14px rgba(31,111,235,.25);
    font-size: var(--fs-2);
  }
  .btn-action.secondary{ background: var(--c2); }

  .sheet{
    background: var(--card);
    border:1px solid var(--border);
    border-radius: 16px;             /* NOVO: raio maior */
    padding: 16px;
    margin-bottom: 20px;
    box-shadow:0 1px 3px rgba(0,0,0,0.05);
  }

  .hidden{ display:none !important; }

  .row{ display:flex; gap:12px; flex-wrap:wrap; }

  .form-card{
    flex:1 1 480px;
    border:1px solid var(--border);
    border-radius:12px;
    padding:12px;
    background:#ffffff;
    box-shadow:0 1px 3px rgba(0,0,0,0.04);
  }

  .form-grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(200px, 1fr)); /* NOVO: colunas mais largas */
    gap:12px;
  }

  .field{ display:flex; flex-direction:column; gap:6px; }
  label{ font-size: var(--fs-3); color:#374151; }

  input, select{
    padding:12px;                    /* NOVO: toque maior */
    border-radius:10px;
    border:1px solid var(--border);
    background:#f0f2f5;
    color:#1f2937;
    font-size: var(--fs-2);
  }

  /* TABELA: padr√£o (desktop/tablet) */
  .table-wrap{ width:100%; overflow:auto; }     /* NOVO: wrapper com scroll horizontal */
  table{ width:100%; border-collapse: collapse; margin-top:12px; font-size:.95rem; }
  th, td{ border-bottom:1px solid var(--border); padding:10px; text-align:left; }
  th{ background:#f3f4f6; color:#374151; position:sticky; top:0; z-index:1; }
  .table-actions{ display:flex; gap:8px; flex-wrap:wrap; }
  .section-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }

  .muted{ color: var(--muted); font-size: var(--fs-3); }

  .tag{
    display:inline-block; padding:6px 10px; border-radius:999px;
    background:#e5e7eb; color:#374151; font-size:.85rem; border:1px solid var(--border);
  }

  .footer{ margin-top:22px; display:flex; gap:12px; align-items:center; }

  .msg{ font-size:.9rem; }
  .msg.ok{ color: var(--ok); }
  .msg.err{ color: var(--danger); }

  /* FILTROS */
  .filters{
    background:#ffffff; border:1px solid var(--border); border-radius:16px; padding:12px; margin:18px 0;
    box-shadow:0 1px 3px rgba(0,0,0,0.04);
  }
  .filters-grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(180px, 1fr));
    gap:12px;
  }
  .pill{
    border:1px dashed var(--border); background:#eef0f3; color:#374151;
    border-radius:999px; padding:6px 10px; font-size:.85rem;
  }

  /* MODAL */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:99; }
  .modal{ width:min(520px, 92vw); background:#ffffff; border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 4px 12px rgba(0,0,0,0.15); }
  .modal h3{ margin-bottom:8px; color:#1f2937; }

  /* ============ BREAKPOINTS ============ */

  /* üì± Mobile (at√© 640px) */
  @media (max-width: 640px){
    .container{ padding: 12px; }
    .topbar{ flex-wrap: wrap; gap: 10px; }
    .nav{ width:100%; order:3; justify-content:flex-start; }
    .userbox{ width:100%; order:2; justify-content:flex-start; }
    .brand{ order:1; }

    .form-grid{
      grid-template-columns: 1fr;        /* forms em uma coluna */
    }

    /* Tabelas como cart√µes empilhados (legibilidade no celular) */
    table, thead, tbody, th, td, tr{ display:block; }
    thead{ display:none; }
    table{ border:0; }
    tbody tr{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      margin-bottom:12px;
      background:#fff;
      box-shadow:0 1px 2px rgba(0,0,0,0.04);
    }
    td{
      border:0; padding:6px 0;
    }
    /* R√≥tulos sintetizados via data-attr (ver JS/HTML abaixo) */
    td[data-label]::before{
      content: attr(data-label) ": ";
      font-weight:600; color:#374151; margin-right:6px;
      display:inline-block; min-width: 120px;
    }

    .btn, .btn-action{ width: 100%; }  /* toque facilitado no mobile */
    .section-actions{ flex-direction:column; }
  }

  /* üìó Tablet (641‚Äì1024px) */
  @media (min-width: 641px) and (max-width: 1024px){
    .container{ padding: 16px; }
    .form-grid{ grid-template-columns: repeat(2, minmax(220px,1fr)); }
    .row{ gap:16px; }
    .table-wrap{ overflow:auto; } /* scroll horizontal se necess√°rio */
  }

  /* üíª Desktop (‚â• 1025px) */
  @media (min-width: 1025px){
    .container{ padding: 20px 24px; }
    .form-grid{ grid-template-columns: repeat(2, minmax(240px,1fr)); }
    .row{ gap:18px; }
  }
  </style>
</head>
<body>
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="brand">
      <span>Controle BWU & Carretas</span>
      <span class="tag">com Usu√°rios & Auditoria</span>
    </div>
    <div class="nav">
      <button id="navToggleBWU" class="btn">BWU</button>
      <button id="navToggleCar" class="btn">Carretas</button>
      <div class="sep"></div>
      <button id="navToggleAdmin" class="btn">Administra√ß√£o</button>
    </div>
    <div class="userbox">
      <span id="currentUserName">N√£o autenticado</span>
      <span id="currentUserRole" class="role-badge">‚Äî</span>
      <button id="btnLogin" class="btn primary">Entrar</button>
      <button id="btnLogout" class="btn warn hidden">Sair</button>
    </div>
  </div>

  <div class="container">
    <h3>A√ß√µes R√°pidas</h3>
    <div class="action-buttons">
      <button class="btn-action" id="btnBWU">+ Controle Instala√ß√£o/Remo√ß√£o BWU</button>
      <button class="btn-action secondary" id="btnCarretas">+ Controle Instala√ß√£o/Remo√ß√£o Carretas</button>
    </div>

    <!-- üîé FILTROS GERAIS -->
    <section class="filters" aria-label="Filtros e Busca">
      <h3>Filtros & Busca</h3>
      <div class="filters-grid">
        <div class="field">
          <label for="fDataIni">Data - De</label>
          <input type="date" id="fDataIni" />
        </div>
        <div class="field">
          <label for="fDataFim">Data - At√©</label>
          <input type="date" id="fDataFim" />
        </div>
        <div class="field">
          <label for="fBusca">Busca livre (texto)</label>
          <input id="fBusca" placeholder="Ex.:Carreta 35, MCP1 50K0." />
        </div>

        <div class="field">
          <label for="fMaquina">M√°quina </label>
          <input id="fMaquina" placeholder="Ex.: PO ou GO" />
        </div>
        <div class="field">
          <label for="fCarreta">Carreta</label>
          <input id="fCarreta" placeholder="Ex.:CJ25" />
        </div>
        <div class="field">
          <label for="fFalha">Falha (Remo√ß√µes)</label>
          <input id="fFalha" placeholder="Ex.:Carreta amassada,Falha 1.40..." />
        </div>
      </div>
      <div class="filters-actions">
        <button class="btn primary" id="btnAplicarFiltros">Aplicar filtros</button>
        <button class="btn warn" id="btnLimparFiltros">Limpar filtros</button>
        <span class="pill" id="resumoFiltros"></span>
      </div>
      <p class="muted">Os filtros s√£o aplicados √†s quatro tabelas. Combine per√≠odo, m√°quina, carreta, falha e busca livre.</p>
    </section>

    <!-- PLANILHA BWU -->
    <section id="sheetBWU" class="sheet hidden" aria-label="Controle BWU">
      <h2>Controle Instala√ß√£o/Remo√ß√£o BWU <span class="tag">BWU</span></h2>
      <p class="muted">Use a barra de filtros para localizar registros. Permiss√µes conforme o perfil.</p>

      <div class="row">
        <!-- Instala√ß√£o BWU -->
        <div class="form-card" id="bwuInstalacaoCard">
          <h3>Instala√ß√£o (BWU)</h3>
          <form id="formBwuInstalacao" class="form-grid" autocomplete="off">
            <div class="field">
              <label for="bwuI_numeroSerie">N√∫mero de s√©rie *</label>
              <input id="bwuI_numeroSerie" required placeholder="Ex.: 021511..." />
            </div>
            <div class="field">
              <label for="bwuI_data">Data *</label>
              <input id="bwuI_data" type="date" required />
            </div>
            <div class="field">
              <label for="bwuI_maquina">M√°quina *</label>
              <input id="bwuI_maquina" required placeholder="Ex.: PO ou GO" />
            </div>
            <div class="field">
              <label for="bwuI_posicao">Posi√ß√£o *</label>
              <input id="bwuI_posicao" required placeholder="Ex.: MCP1 50k0." />
            </div>
            <div class="section-actions" style="grid-column: 1 / -1;">
              <button class="btn primary" type="submit" data-perm="add">Salvar registro</button>
              <button class="btn" type="button" id="exportBwuInstCSV">Exportar CSV (Instala√ß√£o)</button>
              <button class="btn warn" type="button" id="clearBwuInst" data-perm="clearAll">Limpar registros</button>
              <span class="msg" id="msgBwuInst"></span>
            </div>
          </form>
          <table id="tableBwuInst">
            <thead>
              <tr>
                <th>N√∫mero de s√©rie</th>
                <th>Data</th>
                <th>M√°quina</th>
                <th>Posi√ß√£o</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Remo√ß√£o BWU -->
        <div class="form-card" id="bwuRemocaoCard">
          <h3>Remo√ß√£o (BWU)</h3>
          <form id="formBwuRemocao" class="form-grid" autocomplete="off">
            <div class="field">
              <label for="bwuR_numeroSerie">N√∫mero de s√©rie *</label>
              <input id="bwuR_numeroSerie" required placeholder="Ex.: 021511..." />
            </div>
            <div class="field">
              <label for="bwuR_data">Data *</label>
              <input id="bwuR_data" type="date" required />
            </div>
            <div class="field">
              <label for="bwuR_maquina">M√°quina *</label>
              <input id="bwuR_maquina" required placeholder="Ex.: PO ou GO" />
            </div>
            <div class="field">
              <label for="bwuR_posicao">Posi√ß√£o *</label>
              <input id="bwuR_posicao" required placeholder="Ex.: MCP1 50k0." />
            </div>
            <div class="field">
              <label for="bwuR_falha">Falha (motivo da remo√ß√£o)</label>
              <input id="bwuR_falha" placeholder="Ex.: Falha 1.40" />
            </div>
            <div class="section-actions" style="grid-column: 1 / -1;">
              <button class="btn primary" type="submit" data-perm="add">Salvar registro</button>
              <button class="btn" type="button" id="exportBwuRemCSV">Exportar CSV (Remo√ß√£o)</button>
              <button class="btn warn" type="button" id="clearBwuRem" data-perm="clearAll">Limpar registros</button>
              <span class="msg" id="msgBwuRem"></span>
            </div>
          </form>
          <table id="tableBwuRem">
            <thead>
              <tr>
                <th>N√∫mero de s√©rie</th>
                <th>Data</th>
                <th>M√°quina</th>
                <th>Posi√ß√£o</th>
                <th>Falha</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="footer">
        <button class="btn success" id="saveBwuStorage">Salvar no navegador (BWU)</button>
      </div>
    </section>

    <!-- PLANILHA CARRETAS -->
    <section id="sheetCarretas" class="sheet hidden" aria-label="Controle Carretas">
      <h2>Controle Instala√ß√£o/Remo√ß√£o Carretas <span class="tag">Carretas</span></h2>
      <p class="muted">Permiss√µes conforme o perfil. Exclua linhas com cuidado.</p>

      <div class="row">
        <!-- Instala√ß√£o Carretas -->
        <div class="form-card" id="carInstCard">
          <h3>Instala√ß√£o (Carretas)</h3>
          <form id="formCarInst" class="form-grid" autocomplete="off">
            <div class="field">
              <label for="carI_carreta">Carreta *</label>
              <input id="carI_carreta" required placeholder="Ex.: CJ25" />
            </div>
            <div class="field">
              <label for="carI_data">Data *</label>
              <input id="carI_data" type="date" required />
            </div>
            <div class="field">
              <label for="carI_posicao">Posi√ß√£o *</label>
              <input id="carI_posicao" required placeholder="Ex.: 40." />
            </div>
            <div class="section-actions" style="grid-column: 1 / -1;">
              <button class="btn primary" type="submit" data-perm="add">Salvar registro</button>
              <button class="btn" type="button" id="exportCarInstCSV">Exportar CSV (Instala√ß√£o)</button>
              <button class="btn warn" type="button" id="clearCarInst" data-perm="clearAll">Limpar registros</button>
              <span class="msg" id="msgCarInst"></span>
            </div>
          </form>
          <table id="tableCarInst">
            <thead>
              <tr>
                <th>Carreta</th>
                <th>Data</th>
                <th>Posi√ß√£o</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Remo√ß√£o Carretas -->
        <div class="form-card" id="carRemCard">
          <h3>Remo√ß√£o (Carretas)</h3>
          <form id="formCarRem" class="form-grid" autocomplete="off">
            <div class="field">
              <label for="carR_carreta">Carreta *</label>
              <input id="carR_carreta" required placeholder="Ex.: CJ25" />
            </div>
            <div class="field">
              <label for="carR_data">Data *</label>
              <input id="carR_data" type="date" required />
            </div>
            <div class="field">
              <label for="carR_posicao">Posi√ß√£o *</label>
              <input id="carR_posicao" required placeholder="Ex.: 40." />
            </div>
            <div class="field">
              <label for="carR_falha">Falha (motivo da remo√ß√£o)</label>
              <input id="carR_falha" placeholder="Ex.: Carreta amassada" />
            </div>
            <div class="section-actions" style="grid-column: 1 / -1;">
              <button class="btn primary" type="submit" data-perm="add">Salvar registro</button>
              <button class="btn" type="button" id="exportCarRemCSV">Exportar CSV (Remo√ß√£o)</button>
              <button class="btn warn" type="button" id="clearCarRem" data-perm="clearAll">Limpar registros</button>
              <span class="msg" id="msgCarRem"></span>
            </div>
          </form>
          <table id="tableCarRem">
            <thead>
              <tr>
                <th>Carreta</th>
                <th>Data</th>
                <th>Posi√ß√£o</th>
                <th>Falha</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="footer">
        <button class="btn success" id="saveCarStorage">Salvar no navegador (Carretas)</button>
      </div>
    </section>

    <!-- ADMINISTRA√á√ÉO -->
    <section id="sheetAdmin" class="sheet hidden" aria-label="Administra√ß√£o">
      <h2>Administra√ß√£o</h2>
      <p class="muted">Apenas <strong>Admin</strong> tem acesso √†s fun√ß√µes desta se√ß√£o.</p>

      <div class="admin-grid">
        <!-- Gest√£o de Usu√°rios -->
        <div class="form-card" id="usersCard">
          <h3>Usu√°rios</h3>
          <div class="note">Perfis: <strong>admin</strong> (total), <strong>operador</strong> (inclui/exclui), <strong>visualizador</strong> (somente leitura).</div>
          <form id="formAddUser" class="form-grid" autocomplete="off" style="margin-top:10px;">
            <div class="field">
              <label for="u_username">Usu√°rio *</label>
              <input id="u_username" required placeholder="Digite sua matr√≠cula" />
            </div>
            <div class="field">
              <label for="u_name">Nome *</label>
              <input id="u_name" required placeholder="ex.: Luis Carlos" />
            </div>
            <div class="field">
              <label for="u_role">Perfil *</label>
              <select id="u_role">
                <option value="visualizador">visualizador</option>
                <option value="operador">operador</option>
                <option value="admin">admin</option>
              </select>
            </div>
            <div class="field">
              <label for="u_password">Senha *</label>
              <input id="u_password" type="password" required placeholder="senha padr√£o: 123456" />
            </div>
            <div class="section-actions" style="grid-column:1 / -1;">
              <button class="btn primary" type="submit" data-perm="manageUsers">Adicionar usu√°rio</button>
            </div>
          </form>

          <table id="tableUsers">
            <thead>
              <tr>
                <th>Usu√°rio</th><th>Nome</th><th>Perfil</th><th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Log de Auditoria -->
        <div class="form-card" id="auditCard">
          <h3>Log de Auditoria</h3>
          <div class="form-grid">
            <div class="field">
              <label for="aDataIni">Data - De</label>
              <input type="date" id="aDataIni" />
            </div>
            <div class="field">
              <label for="aDataFim">Data - At√©</label>
              <input type="date" id="aDataFim" />
            </div>
            <div class="field">
              <label for="aUser">Usu√°rio</label>
              <input id="aUser" placeholder="ex.: admin" />
            </div>
            <div class="field">
              <label for="aAction">A√ß√£o</label>
              <input id="aAction" placeholder="ex.: create, delete, export_csv..." />
            </div>
            <div class="field">
              <label for="aScope">Escopo</label>
              <input id="aScope" placeholder="ex.: bwuInst, carRem, users, auth" />
            </div>
            <div class="field">
              <label for="aBusca">Busca livre</label>
              <input id="aBusca" placeholder="texto livre" />
            </div>
          </div>
          <div class="section-actions">
            <button class="btn" id="btnAuditApply">Aplicar</button>
            <button class="btn warn" id="btnAuditClear">Limpar filtros</button>
            <button class="btn" id="btnAuditExport">Exportar CSV (Log)</button>
          </div>

          <table id="tableAudit">
            <thead>
              <tr>
                <th>Data/Hora</th><th>Usu√°rio</th><th>A√ß√£o</th><th>Escopo</th><th>Item</th><th>Detalhes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- MODAL LOGIN / ADMIN SETUP -->
  <div id="authModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal">
      <h3 id="authTitle">Entrar</h3>
      <p id="authDesc" class="muted">Informe suas credenciais.</p>
      <form id="formAuth" class="form-grid" autocomplete="off" style="margin-top:6px;">
        <div class="field">
          <label for="authUser">Usu√°rio</label>
          <input id="authUser" required />
        </div>
        <div class="field">
          <label for="authPass">Senha</label>
          <input id="authPass" type="password" required />
        </div>
        <div class="section-actions" style="grid-column:1 / -1;">
          <button class="btn primary" type="submit" id="btnDoLogin">Entrar</button>
          <button class="btn" type="button" id="btnCancelLogin">Cancelar</button>
        </div>
      </form>

      <form id="formFirstAdmin" class="form-grid hidden" autocomplete="off" style="margin-top:6px;">
        <div class="field">
          <label for="faUser">Usu√°rio (Admin) *</label>
          <input id="faUser" required placeholder="ex.: admin" />
        </div>
        <div class="field">
          <label for="faName">Nome *</label>
          <input id="faName" required placeholder="ex.: Administrador" />
        </div>
        <div class="field">
          <label for="faPass">Senha *</label>
          <input id="faPass" type="password" required placeholder="m√≠n. 6 caracteres" />
        </div>
        <div class="section-actions" style="grid-column:1 / -1;">
          <button class="btn primary" type="submit">Criar Admin</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function(){
      // ---------- Estado e armazenamento ----------
      const state = {
        bwuInst: [], bwuRem: [], carInst: [], carRem: [],
        users: [], audit: [],
        currentUser: null
      };
      const STORAGE_KEYS = {
        bwuInst: 'CTRL_BWU_INST',
        bwuRem:  'CTRL_BWU_REM',
        carInst: 'CTRL_CAR_INST',
        carRem:  'CTRL_CAR_REM',
        users:   'CTRL_USERS',
        current: 'CTRL_CURRENT_USER',
        audit:   'CTRL_AUDIT'
      };

      // Permiss√µes por perfil
      const ROLE_PERMS = {
        visualizador: { add:false, delete:false, clearAll:false, export:true, manageUsers:false },
        operador:     { add:true,  delete:true,  clearAll:false, export:true, manageUsers:false },
        admin:        { add:true,  delete:true,  clearAll:true,  export:true, manageUsers:true }
      };
      const can = (action) => {
        const role = state.currentUser?.role || 'visualizador';
        return !!ROLE_PERMS[role]?.[action];
      };

      // ---------- Utilit√°rios ----------
      const uid = () => String(Date.now()) + Math.random().toString(16).slice(2);
      const fmtDate = (d) => d || ''; // yyyy-mm-dd

      async function sha256(str){
        const enc = new TextEncoder().encode(str);
        const buf = await crypto.subtle.digest('SHA-256', enc);
        return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }

      function escapeCSV(v){
        const s = (v ?? '').toString();
        const needsQuote = /[;"\n,]/.test(s);
        const q = '"' + s.replace(/"/g,'""') + '"';
        return needsQuote ? q : s;
      }
      function exportToCSV(filename, rows, headers){
        const headerLine = headers.map(escapeCSV).join(';');
        const dataLines  = rows.map(r => headers.map(h => escapeCSV(r[h])).join(';'));
        const csv = [headerLine, ...dataLines].join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
      }

      function setMsg(el, text, type='ok'){
        el.textContent = text;
        el.className = 'msg ' + (type === 'ok' ? 'ok' : 'err');
        setTimeout(()=>{ el.textContent=''; el.className='msg'; }, 2600);
      }

      function sanitizeUser(u){ // para exibir/logar sem hash
        if (!u) return null;
        const {id, username, name, role} = u;
        return {id, username, name, role};
      }

      // ---------- Persist√™ncia ----------
      function loadFromStorage(){
        for (const [k, key] of Object.entries(STORAGE_KEYS)){
          try{
            const val = localStorage.getItem(key);
            if (!val) continue;
            state[k] = JSON.parse(val);
          }catch(e){ console.warn('Falha ao carregar', k, e); }
        }
      }
      function saveDataSets(){
        try{
          localStorage.setItem(STORAGE_KEYS.bwuInst, JSON.stringify(state.bwuInst));
          localStorage.setItem(STORAGE_KEYS.bwuRem,  JSON.stringify(state.bwuRem));
          localStorage.setItem(STORAGE_KEYS.carInst, JSON.stringify(state.carInst));
          localStorage.setItem(STORAGE_KEYS.carRem,  JSON.stringify(state.carRem));
        }catch(e){ console.warn('Falha ao salvar datasets', e); }
      }
      function saveUsers(){
        try{ localStorage.setItem(STORAGE_KEYS.users, JSON.stringify(state.users)); }
        catch(e){ console.warn('Falha ao salvar usu√°rios', e); }
      }
      function saveCurrentUser(){
        try{ localStorage.setItem(STORAGE_KEYS.current, JSON.stringify(state.currentUser ? sanitizeUser(state.currentUser) : null)); }
        catch(e){ console.warn('Falha ao salvar usu√°rio atual', e); }
      }
      function saveAudit(){
        try{ localStorage.setItem(STORAGE_KEYS.audit, JSON.stringify(state.audit)); }
        catch(e){ console.warn('Falha ao salvar auditoria', e); }
      }

      // ---------- Auditoria ----------
      function audit(action, scope, itemId=null, before=null, after=null, extra={}){
        const entry = {
          id: uid(),
          ts: new Date().toISOString(),
          user: state.currentUser?.username || 'system',
          action, scope, itemId,
          before, after,
          ...extra
        };
        state.audit.unshift(entry); // mais recente no topo
        saveAudit();
        renderAudit();
      }

      // ---------- Filtros de dados ----------
      const filters = { dataIni:'', dataFim:'', busca:'', maquina:'', carreta:'', falha:'' };
      const elDataIni = document.getElementById('fDataIni');
      const elDataFim = document.getElementById('fDataFim');
      const elBusca   = document.getElementById('fBusca');
      const elMaq     = document.getElementById('fMaquina');
      const elCar     = document.getElementById('fCarreta');
      const elFalha   = document.getElementById('fFalha');
      const elResumo  = document.getElementById('resumoFiltros');

      function applyFiltersToRows(rows, kind){
        const f = filters;
        const inRange = (data) => {
          if (!data) return false;
          if (f.dataIni && data < f.dataIni) return false;
          if (f.dataFim && data > f.dataFim) return false;
          return true;
        };
        const contains = (value, needle) => {
          if (!needle) return true;
          return (value ?? '').toString().toLowerCase().includes(needle.toLowerCase());
        };
        const rowMatches = (r) => {
          if (f.dataIni || f.dataFim){ if (!inRange(r.data)) return false; }
          const fullText = [r.numeroSerie,r.maquina,r.posicao,r.carreta,r.falha,r.data].filter(Boolean).join(' ').toLowerCase();
          if (f.busca && !fullText.includes(f.busca.toLowerCase())) return false;
          if ((kind==='bwuInst'||kind==='bwuRem') && f.maquina){ if (!contains(r.maquina,f.maquina)) return false; }
          if ((kind==='carInst'||kind==='carRem') && f.carreta){ if (!contains(r.carreta,f.carreta)) return false; }
          if ((kind==='bwuRem'||kind==='carRem') && f.falha){ if (!contains(r.falha,f.falha)) return false; }
          return true;
        };
        const base = (f.dataIni || f.dataFim) ? rows.filter(r => r.data) : rows;
        return base.filter(rowMatches);
      }
      function resumoFiltros(){
        const parts = [];
        if (filters.dataIni || filters.dataFim) parts.push(`Per√≠odo: ${filters.dataIni || '‚Äî'} a ${filters.dataFim || '‚Äî'}`);
        if (filters.maquina) parts.push(`M√°quina: "${filters.maquina}"`);
        if (filters.carreta) parts.push(`Carreta: "${filters.carreta}"`);
        if (filters.falha)   parts.push(`Falha: "${filters.falha}"`);
        if (filters.busca)   parts.push(`Busca: "${filters.busca}"`);
        elResumo.textContent = parts.length ? parts.join(' ‚Ä¢ ') : 'Sem filtros aplicados';
      }

      // ---------- Renderiza√ß√£o de tabelas ----------
      const tbBwuInst = document.querySelector('#tableBwuInst tbody');
      const tbBwuRem  = document.querySelector('#tableBwuRem tbody');
      const tbCarInst = document.querySelector('#tableCarInst tbody');
      const tbCarRem  = document.querySelector('#tableCarRem tbody');

      function renderTable(tbody, rows, columns, kind){
        tbody.innerHTML = '';
        if (!rows.length){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = columns.length + 1;
          td.className = 'muted';
          td.textContent = 'Sem registros';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        rows.forEach(row=>{
          const tr = document.createElement('tr');
          columns.forEach(col=>{
            const td = document.createElement('td');
            td.textContent = row[col] ?? '';
            tr.appendChild(td);
          });
          const tdAct = document.createElement('td');
          tdAct.className = 'table-actions';
          const btnDel = document.createElement('button');
          btnDel.className = 'btn danger';
          btnDel.textContent = 'Excluir';
          if (!can('delete')) btnDel.classList.add('hidden');
          btnDel.addEventListener('click', ()=>{
            if (!can('delete')) return;
            deleteRow(row.__id, kind);
          });
          tdAct.appendChild(btnDel);
          tr.appendChild(tdAct);
          tbody.appendChild(tr);
        });
      }

      function deleteRow(id, kindHint=null){
        let changed = false;
        const datasets = ['bwuInst','bwuRem','carInst','carRem'];
        for (const key of datasets){
          const idx = state[key].findIndex(x=>x.__id === id);
          if (idx >= 0){
            const before = state[key][idx];
            state[key].splice(idx,1);
            audit('delete', key, id, before, null);
            changed = true;
            break;
          }
        }
        if (changed){
          saveDataSets();
          renderAll();
        }
      }

      function renderAll(){
        const bwuInstRows = applyFiltersToRows(state.bwuInst, 'bwuInst');
        const bwuRemRows  = applyFiltersToRows(state.bwuRem,  'bwuRem');
        const carInstRows = applyFiltersToRows(state.carInst, 'carInst');
        const carRemRows  = applyFiltersToRows(state.carRem,  'carRem');

        renderTable(tbBwuInst, bwuInstRows, ['numeroSerie','data','maquina','posicao'], 'bwuInst');
        renderTable(tbBwuRem,  bwuRemRows,  ['numeroSerie','data','maquina','posicao','falha'], 'bwuRem');
        renderTable(tbCarInst, carInstRows, ['carreta','data','posicao'], 'carInst');
        renderTable(tbCarRem,  carRemRows,  ['carreta','data','posicao','falha'], 'carRem');

        resumoFiltros();
        applyPermissionsToUI();
      }

      // ---------- UI: atualiza√ß√£o por permiss√µes ----------
      const permMap = {
        add:     () => document.querySelectorAll('[data-perm="add"]'),
        clearAll:() => document.querySelectorAll('[data-perm="clearAll"]'),
        manageUsers: () => document.querySelectorAll('[data-perm="manageUsers"]')
      };
      function applyPermissionsToUI(){
        // Bot√µes globais
        document.getElementById('btnLogin').classList.toggle('hidden', !!state.currentUser);
        document.getElementById('btnLogout').classList.toggle('hidden', !state.currentUser);

        // Acesso √† Administra√ß√£o
        const sheetAdmin = document.getElementById('sheetAdmin');
        const adminVisible = can('manageUsers');
        sheetAdmin.classList.toggle('hidden', !adminVisible);

        // Habilitar/Desabilitar por permiss√£o
        const setDisabled = (nodes, allowed) => nodes.forEach(n => n.disabled = !allowed);
        setDisabled(Array.from(permMap.add()), can('add'));
        setDisabled(Array.from(permMap.clearAll()), can('clearAll'));
        setDisabled(Array.from(permMap.manageUsers()), can('manageUsers'));
      }

      // ---------- Autentica√ß√£o ----------
      const authModal = document.getElementById('authModal');
      const authTitle = document.getElementById('authTitle');
      const authDesc  = document.getElementById('authDesc');
      const formAuth  = document.getElementById('formAuth');
      const formFirstAdmin = document.getElementById('formFirstAdmin');
      const elAuthUser = document.getElementById('authUser');
      const elAuthPass = document.getElementById('authPass');

      function openLoginModal(){
        authTitle.textContent = 'Entrar';
        authDesc.textContent  = 'Informe suas credenciais.';
        formAuth.classList.remove('hidden');
        formFirstAdmin.classList.add('hidden');
        authModal.classList.remove('hidden');
        elAuthUser.focus();
      }
      function openFirstAdminModal(){
        authTitle.textContent = 'Configurar Administrador';
        authDesc.textContent  = 'Nenhum usu√°rio encontrado. Crie o usu√°rio Administrador inicial.';
        formAuth.classList.add('hidden');
        formFirstAdmin.classList.remove('hidden');
        authModal.classList.remove('hidden');
        document.getElementById('faUser').focus();
      }
      function closeAuthModal(){
        authModal.classList.add('hidden');
        formAuth.reset(); formFirstAdmin.reset();
      }

      async function tryLogin(username, password){
        const found = state.users.find(u => u.username.toLowerCase() === username.toLowerCase());
        if (!found) return false;
        const ph = await sha256(password);
        if (ph !== found.passHash) return false;
        state.currentUser = sanitizeUser(found);
        saveCurrentUser();
        audit('login', 'auth', null, null, { user: state.currentUser.username });
        updateUserBox();
        applyPermissionsToUI();
        return true;
      }
      function logout(){
        if (!state.currentUser) return;
        audit('logout', 'auth', null, sanitizeUser(state.currentUser), null);
        state.currentUser = null;
        saveCurrentUser();
        updateUserBox();
        applyPermissionsToUI();
      }

      function updateUserBox(){
        const name = state.currentUser?.name || 'N√£o autenticado';
        const role = state.currentUser?.role || '‚Äî';
        document.getElementById('currentUserName').textContent = name;
        document.getElementById('currentUserRole').textContent = role;
      }

      // ---------- Gest√£o de Usu√°rios ----------
      const tbUsers = document.querySelector('#tableUsers tbody');

      function renderUsers(){
        tbUsers.innerHTML = '';
        if (!state.users.length){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 4; td.className = 'muted'; td.textContent = 'Sem usu√°rios';
          tr.appendChild(td); tbUsers.appendChild(tr); return;
        }
        state.users.forEach(u=>{
          const tr = document.createElement('tr');
          const tdU = document.createElement('td'); tdU.textContent = u.username;
          const tdN = document.createElement('td'); tdN.textContent = u.name;
          const tdR = document.createElement('td'); tdR.textContent = u.role;
          const tdA = document.createElement('td'); tdA.className = 'table-actions';

          const btnReset = document.createElement('button');
          btnReset.className = 'btn'; btnReset.textContent = 'Resetar senha';
          btnReset.disabled = !can('manageUsers');
          btnReset.addEventListener('click', async ()=>{
            if (!can('manageUsers')) return;
            const np = prompt(`Nova senha para ${u.username}:`);
            if (!np || np.length < 6) return alert('Senha inv√°lida (m√≠n. 6).');
            const oldSan = sanitizeUser(u);
            u.passHash = await sha256(np);
            saveUsers();
            audit('user_reset_password', 'users', u.id, oldSan, null);
            alert('Senha atualizada.');
          });

          const btnDel = document.createElement('button');
          btnDel.className = 'btn danger'; btnDel.textContent = 'Excluir';
          btnDel.disabled = !can('manageUsers');
          btnDel.addEventListener('click', ()=>{
            if (!can('manageUsers')) return;
            if (state.currentUser && u.username === state.currentUser.username){
              return alert('Voc√™ n√£o pode excluir o pr√≥prio usu√°rio em uso.');
            }
            // impedir exclus√£o do √∫ltimo admin
            const admins = state.users.filter(x=>x.role==='admin');
            if (u.role==='admin' && admins.length <= 1){
              return alert('N√£o √© permitido excluir o √∫ltimo Admin.');
            }
            if (confirm(`Excluir usu√°rio ${u.username}?`)){
              const before = sanitizeUser(u);
              state.users = state.users.filter(x=>x.id !== u.id);
              saveUsers();
              renderUsers();
              audit('user_delete', 'users', u.id, before, null);
            }
          });

          tdA.appendChild(btnReset); tdA.appendChild(btnDel);
          tr.appendChild(tdU); tr.appendChild(tdN); tr.appendChild(tdR); tr.appendChild(tdA);
          tbUsers.appendChild(tr);
        });
      }

      document.getElementById('formAddUser').addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!can('manageUsers')) return;
        const username = document.getElementById('u_username').value.trim();
        const name     = document.getElementById('u_name').value.trim();
        const role     = document.getElementById('u_role').value;
        const pass     = document.getElementById('u_password').value;
        if (!username || !name || !pass || pass.length < 6) return alert('Preencha corretamente (senha m√≠n. 6).');
        if (state.users.some(u => u.username.toLowerCase() === username.toLowerCase())){
          return alert('J√° existe um usu√°rio com esse login.');
        }
        const user = { id: uid(), username, name, role, passHash: await sha256(pass) };
        state.users.push(user);
        saveUsers(); renderUsers();
        audit('user_create', 'users', user.id, null, sanitizeUser(user));
        e.target.reset();
      });

      // ---------- Log de Auditoria (UI) ----------
      const aIni = document.getElementById('aDataIni');
      const aFim = document.getElementById('aDataFim');
      const aUser= document.getElementById('aUser');
      const aAct = document.getElementById('aAction');
      const aScp = document.getElementById('aScope');
      const aTxt = document.getElementById('aBusca');
      const tbAudit = document.querySelector('#tableAudit tbody');

      function auditFiltered(){
        const di = aIni.value || null, df = aFim.value || null;
        const u = aUser.value.trim().toLowerCase();
        const ac= aAct.value.trim().toLowerCase();
        const sc= aScp.value.trim().toLowerCase();
        const tx= aTxt.value.trim().toLowerCase();

        return state.audit.filter(e=>{
          if (di && e.ts.slice(0,10) < di) return false;
          if (df && e.ts.slice(0,10) > df) return false;
          if (u && !(e.user||'').toLowerCase().includes(u)) return false;
          if (ac && !(e.action||'').toLowerCase().includes(ac)) return false;
          if (sc && !(e.scope||'').toLowerCase().includes(sc)) return false;

          if (tx){
            const blob = JSON.stringify(e).toLowerCase();
            if (!blob.includes(tx)) return false;
          }
          return true;
        });
      }
      function renderAudit(){
        tbAudit.innerHTML = '';
        const rows = auditFiltered();
        if (!rows.length){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6; td.className='muted'; td.textContent='Sem entradas de log';
          tr.appendChild(td); tbAudit.appendChild(tr); return;
        }
        rows.forEach(e=>{
          const tr = document.createElement('tr');
          const tdTs = document.createElement('td'); tdTs.textContent = e.ts.replace('T',' ').replace('Z','');
          const tdUs = document.createElement('td'); tdUs.textContent = e.user;
          const tdAc = document.createElement('td'); tdAc.textContent = e.action;
          const tdSc = document.createElement('td'); tdSc.textContent = e.scope;
          const tdId = document.createElement('td'); tdId.textContent = e.itemId || '‚Äî';
          const tdDt = document.createElement('td');
          tdDt.textContent = summarizeLogDetail(e);
          tr.appendChild(tdTs); tr.appendChild(tdUs); tr.appendChild(tdAc); tr.appendChild(tdSc); tr.appendChild(tdId); tr.appendChild(tdDt);
          tbAudit.appendChild(tr);
        });
      }
      function summarizeLogDetail(e){
        try{
          if (e.action==='create') return 'criado';
          if (e.action==='delete') return 'exclu√≠do';
          if (e.action==='clear_all') return `limpeza total (${e?.before?.count||0} itens)`;
          if (e.action==='export_csv') return `exporta√ß√£o (${e?.before?.count||0} itens) ‚Üí ${e?.after?.filename||''}`;
          if (e.action==='login') return `login: ${e?.after?.user||''}`;
          if (e.action==='logout') return `logout`;
          if (e.action==='user_create') return `novo usu√°rio: ${e?.after?.username} (${e?.after?.role})`;
          if (e.action==='user_delete') return `usu√°rio removido: ${e?.before?.username}`;
          if (e.action==='user_reset_password') return `senha redefinida: ${e?.before?.username}`;
          return JSON.stringify({before:e.before, after:e.after});
        }catch{ return ''; }
      }

      document.getElementById('btnAuditApply').addEventListener('click', renderAudit);
      document.getElementById('btnAuditClear').addEventListener('click', ()=>{
        aIni.value=''; aFim.value=''; aUser.value=''; aAct.value=''; aScp.value=''; aTxt.value='';
        renderAudit();
      });
      document.getElementById('btnAuditExport').addEventListener('click', ()=>{
        const rows = auditFiltered().map(e=>({
          ts: e.ts, usuario: e.user, acao: e.action, escopo: e.scope, item: e.itemId || '',
          detalhes: summarizeLogDetail(e)
        }));
        exportToCSV('auditoria.csv', rows, ['ts','usuario','acao','escopo','item','detalhes']);
      });

      // ---------- Eventos dos filtros gerais ----------
      document.getElementById('btnAplicarFiltros').addEventListener('click', ()=>{
        filters.dataIni = elDataIni.value || '';
        filters.dataFim = elDataFim.value || '';
        filters.busca   = elBusca.value.trim();
        filters.maquina = elMaq.value.trim();
        filters.carreta = elCar.value.trim();
        filters.falha   = elFalha.value.trim();
        renderAll();
      });
      document.getElementById('btnLimparFiltros').addEventListener('click', ()=>{
        elDataIni.value = ''; elDataFim.value = '';
        elBusca.value = ''; elMaq.value = ''; elCar.value = ''; elFalha.value = '';
        filters.dataIni = ''; filters.dataFim = ''; filters.busca = '';
        filters.maquina = ''; filters.carreta = ''; filters.falha = '';
        renderAll();
      });

      // Atualiza√ß√£o din√¢mica (UX opcional)
      ;['input','change'].forEach(ev=>{
        [elDataIni, elDataFim, elBusca, elMaq, elCar, elFalha].forEach(el=>{
          el.addEventListener(ev, ()=>{
            filters.dataIni = elDataIni.value || '';
            filters.dataFim = elDataFim.value || '';
            filters.busca   = elBusca.value.trim();
            filters.maquina = elMaq.value.trim();
            filters.carreta = elCar.value.trim();
            filters.falha   = elFalha.value.trim();
            renderAll();
          });
        });
      });

      // ---------- Formul√°rios de dados ----------
      const msgBwuInst = document.getElementById('msgBwuInst');
      const msgBwuRem  = document.getElementById('msgBwuRem');
      const msgCarInst = document.getElementById('msgCarInst');
      const msgCarRem  = document.getElementById('msgCarRem');

      // BWU - Instala√ß√£o
      document.getElementById('formBwuInstalacao').addEventListener('submit', (e)=>{
        e.preventDefault();
        if (!can('add')) return setMsg(msgBwuInst, 'Sem permiss√£o para adicionar.', 'err');
        const numeroSerie = document.getElementById('bwuI_numeroSerie').value.trim();
        const data        = document.getElementById('bwuI_data').value;
        const maquina     = document.getElementById('bwuI_maquina').value.trim();
        const posicao     = document.getElementById('bwuI_posicao').value.trim();
        if (!numeroSerie || !data || !maquina || !posicao){
          setMsg(msgBwuInst, 'Preencha todos os campos obrigat√≥rios.', 'err'); return;
        }
        const row = { __id: uid(), numeroSerie, data: fmtDate(data), maquina, posicao };
        state.bwuInst.push(row);
        saveDataSets();
        audit('create', 'bwuInst', row.__id, null, row);
        renderAll(); e.target.reset();
        setMsg(msgBwuInst, 'Registro de instala√ß√£o (BWU) salvo.');
      });
      document.getElementById('exportBwuInstCSV').addEventListener('click', ()=>{
        const rows = applyFiltersToRows(state.bwuInst, 'bwuInst');
        exportToCSV('bwu_instalacao.csv', rows, ['numeroSerie','data','maquina','posicao']);
        audit('export_csv', 'bwuInst', null, {count: rows.length}, {filename:'bwu_instalacao.csv'});
      });
      document.getElementById('clearBwuInst').addEventListener('click', ()=>{
        if (!can('clearAll')) return alert('Sem permiss√£o para limpar.');
        if (confirm('Deseja limpar TODOS os registros de Instala√ß√£o (BWU)?')){
          const beforeCount = state.bwuInst.length;
          state.bwuInst = [];
          saveDataSets(); renderAll();
          audit('clear_all', 'bwuInst', null, {count: beforeCount}, null);
          setMsg(msgBwuInst, 'Registros limpos.');
        }
      });

      // BWU - Remo√ß√£o
      document.getElementById('formBwuRemocao').addEventListener('submit', (e)=>{
        e.preventDefault();
        if (!can('add')) return setMsg(msgBwuRem, 'Sem permiss√£o para adicionar.', 'err');
        const numeroSerie = document.getElementById('bwuR_numeroSerie').value.trim();
        const data        = document.getElementById('bwuR_data').value;
        const maquina     = document.getElementById('bwuR_maquina').value.trim();
        const posicao     = document.getElementById('bwuR_posicao').value.trim();
        const falha       = document.getElementById('bwuR_falha').value.trim();
        if (!numeroSerie || !data || !maquina || !posicao){
          setMsg(msgBwuRem, 'Preencha todos os campos obrigat√≥rios.', 'err'); return;
        }
        const row = { __id: uid(), numeroSerie, data: fmtDate(data), maquina, posicao, falha };
        state.bwuRem.push(row);
        saveDataSets();
        audit('create', 'bwuRem', row.__id, null, row);
        renderAll(); e.target.reset();
        setMsg(msgBwuRem, 'Registro de remo√ß√£o (BWU) salvo.');
      });
      document.getElementById('exportBwuRemCSV').addEventListener('click', ()=>{
        const rows = applyFiltersToRows(state.bwuRem, 'bwuRem');
        exportToCSV('bwu_remocao.csv', rows, ['numeroSerie','data','maquina','posicao','falha']);
        audit('export_csv', 'bwuRem', null, {count: rows.length}, {filename:'bwu_remocao.csv'});
      });
      document.getElementById('clearBwuRem').addEventListener('click', ()=>{
        if (!can('clearAll')) return alert('Sem permiss√£o para limpar.');
        if (confirm('Deseja limpar TODOS os registros de Remo√ß√£o (BWU)?')){
          const beforeCount = state.bwuRem.length;
          state.bwuRem = [];
          saveDataSets(); renderAll();
          audit('clear_all', 'bwuRem', null, {count: beforeCount}, null);
          setMsg(msgBwuRem, 'Registros limpos.');
        }
      });

      // CARRETAS - Instala√ß√£o
      document.getElementById('formCarInst').addEventListener('submit', (e)=>{
        e.preventDefault();
        if (!can('add')) return setMsg(msgCarInst, 'Sem permiss√£o para adicionar.', 'err');
        const carreta = document.getElementById('carI_carreta').value.trim();
        const data    = document.getElementById('carI_data').value;
        const posicao = document.getElementById('carI_posicao').value.trim();
        if (!carreta || !data || !posicao){
          setMsg(msgCarInst, 'Preencha todos os campos obrigat√≥rios.', 'err'); return;
        }
        const row = { __id: uid(), carreta, data: fmtDate(data), posicao };
        state.carInst.push(row);
        saveDataSets();
        audit('create', 'carInst', row.__id, null, row);
        renderAll(); e.target.reset();
        setMsg(msgCarInst, 'Registro de instala√ß√£o (Carretas) salvo.');
      });
      document.getElementById('exportCarInstCSV').addEventListener('click', ()=>{
        const rows = applyFiltersToRows(state.carInst, 'carInst');
        exportToCSV('carretas_instalacao.csv', rows, ['carreta','data','posicao']);
        audit('export_csv', 'carInst', null, {count: rows.length}, {filename:'carretas_instalacao.csv'});
      });
      document.getElementById('clearCarInst').addEventListener('click', ()=>{
        if (!can('clearAll')) return alert('Sem permiss√£o para limpar.');
        if (confirm('Deseja limpar TODOS os registros de Instala√ß√£o (Carretas)?')){
          const beforeCount = state.carInst.length;
          state.carInst = [];
          saveDataSets(); renderAll();
          audit('clear_all', 'carInst', null, {count: beforeCount}, null);
          setMsg(msgCarInst, 'Registros limpos.');
        }
      });

      // CARRETAS - Remo√ß√£o
      document.getElementById('formCarRem').addEventListener('submit', (e)=>{
        e.preventDefault();
        if (!can('add')) return setMsg(msgCarRem, 'Sem permiss√£o para adicionar.', 'err');
        const carreta = document.getElementById('carR_carreta').value.trim();
        const data    = document.getElementById('carR_data').value;
        const posicao = document.getElementById('carR_posicao').value.trim();
        const falha   = document.getElementById('carR_falha').value.trim();
        if (!carreta || !data || !posicao){
          setMsg(msgCarRem, 'Preencha todos os campos obrigat√≥rios.', 'err'); return;
        }
        const row = { __id: uid(), carreta, data: fmtDate(data), posicao, falha };
        state.carRem.push(row);
        saveDataSets();
        audit('create', 'carRem', row.__id, null, row);
        renderAll(); e.target.reset();
        setMsg(msgCarRem, 'Registro de remo√ß√£o (Carretas) salvo.');
      });
      document.getElementById('exportCarRemCSV').addEventListener('click', ()=>{
        const rows = applyFiltersToRows(state.carRem, 'carRem');
        exportToCSV('carretas_remocao.csv', rows, ['carreta','data','posicao','falha']);
        audit('export_csv', 'carRem', null, {count: rows.length}, {filename:'carretas_remocao.csv'});
      });
      document.getElementById('clearCarRem').addEventListener('click', ()=>{
        if (!can('clearAll')) return alert('Sem permiss√£o para limpar.');
        if (confirm('Deseja limpar TODOS os registros de Remo√ß√£o (Carretas)?')){
          const beforeCount = state.carRem.length;
          state.carRem = [];
          saveDataSets(); renderAll();
          audit('clear_all', 'carRem', null, {count: beforeCount}, null);
          setMsg(msgCarRem, 'Registros limpos.');
        }
      });

      // ---------- Bot√µes gerais ----------
      document.getElementById('saveBwuStorage').addEventListener('click', ()=>{
        saveDataSets(); alert('Dados BWU salvos no navegador.');
      });
      document.getElementById('saveCarStorage').addEventListener('click', ()=>{
        saveDataSets(); alert('Dados Carretas salvos no navegador.');
      });

      // Navega√ß√£o (A√ß√µes R√°pidas + Topbar)
      const sheetBWU = document.getElementById('sheetBWU');
      const sheetCar = document.getElementById('sheetCarretas');
      const sheetAdm = document.getElementById('sheetAdmin');
      function toggleSection(el){ el.classList.toggle('hidden'); if (!el.classList.contains('hidden')) el.scrollIntoView({behavior:'smooth'}); }
      document.getElementById('btnBWU').addEventListener('click', ()=> toggleSection(sheetBWU));
      document.getElementById('btnCarretas').addEventListener('click', ()=> toggleSection(sheetCar));
      document.getElementById('navToggleBWU').addEventListener('click', ()=> toggleSection(sheetBWU));
      document.getElementById('navToggleCar').addEventListener('click', ()=> toggleSection(sheetCar));
      document.getElementById('navToggleAdmin').addEventListener('click', ()=>{
        if (!can('manageUsers')) return alert('Apenas Admin pode abrir Administra√ß√£o.');
        toggleSection(sheetAdm);
      });

      // Login/Logout
      document.getElementById('btnLogin').addEventListener('click', ()=>{
        if (!state.users.length) openFirstAdminModal(); else openLoginModal();
      });
      document.getElementById('btnCancelLogin').addEventListener('click', closeAuthModal);
      document.getElementById('btnLogout').addEventListener('click', logout);
      formAuth.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const ok = await tryLogin(elAuthUser.value.trim(), elAuthPass.value);
        if (!ok) return alert('Usu√°rio ou senha inv√°lidos.');
        closeAuthModal(); renderUsers(); renderAudit(); renderAll();
      });
      formFirstAdmin.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const u = document.getElementById('faUser').value.trim();
        const n = document.getElementById('faName').value.trim();
        const p = document.getElementById('faPass').value;
        if (!u || !n || p.length<6) return alert('Preencha corretamente (senha m√≠n. 6).');
        const admin = { id: uid(), username:u, name:n, role:'admin', passHash: await sha256(p) };
        state.users = [admin];
        saveUsers();
        audit('user_create', 'users', admin.id, null, sanitizeUser(admin));
        alert('Administrador criado. Fa√ßa login.');
        openLoginModal();
      });

      // ---------- Inicializa√ß√£o ----------
      loadFromStorage();
      // Restaurar sess√£o simplificada (apenas dados b√°sicos salvos)
      try{
        const cur = JSON.parse(localStorage.getItem(STORAGE_KEYS.current) || 'null');
        if (cur && cur.username){
          // seta currentUser como o salvo (sem validar senha)
          state.currentUser = cur;
        }
      }catch{}
      updateUserBox();
      applyPermissionsToUI();
      renderAll();
      renderUsers();
      renderAudit();

      // Se n√£o houver usu√°rios, for√ßa modal de cria√ß√£o
      if (!state.users.length){
        openFirstAdminModal();
      }
    })();
  </script>
</body>
</html>
