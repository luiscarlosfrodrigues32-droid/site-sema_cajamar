<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o BWU & Carretas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #2c3e50; --secondary-color: #34495e; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .login-container { max-width: 400px; margin: 100px auto; }
        #app-content { display: none; padding: 20px; }
        .nav-tabs .nav-link { color: var(--secondary-color); font-weight: 600; cursor: pointer; }
        .nav-tabs .nav-link.active { border-bottom: 3px solid #0d6efd; color: #0d6efd; }
        .table-container { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-add { height: 38px; font-weight: bold; }
        .is-invalid { border-color: #dc3545 !important; }
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .editing-mode { background-color: #fff3cd !important; border: 2px solid #ffca2c !important; }
    </style>
</head>
<body>

<div id="auth-section" class="login-container">
    <div class="card shadow border-0">
        <div class="card-body p-4">
            <h3 class="text-center mb-4">Acesso ao Sistema</h3>
            <div class="mb-3">
                <label class="form-label">E-mail</label>
                <input type="email" id="login-email" class="form-control" placeholder="admin@empresa.com">
            </div>
            <div class="mb-3">
                <label class="form-label">Senha</label>
                <input type="password" id="login-pass" class="form-control" placeholder="******">
            </div>
            <button class="btn btn-primary w-100" id="btn-login">Entrar</button>
        </div>
    </div>
</div>

<div id="app-content" class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark">Monitoramento de Equipamentos</h2>
        <div>
            <span id="user-display" class="me-3 text-muted small"></span>
            <button class="btn btn-outline-danger btn-sm" id="btn-logout">Sair</button>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-inst-bwu" onclick="cancelEdit()">Instala√ß√£o BWU</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-rem-bwu" onclick="cancelEdit()">Remo√ß√£o BWU</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-inst-carretas" onclick="cancelEdit()">Instala√ß√£o Carretas</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-rem-carretas" onclick="cancelEdit()">Remo√ß√£o Carretas</button></li>
    </ul>

    <div class="tab-content table-container">

        <div class="tab-pane fade show active" id="tab-inst-bwu">
            <div class="row g-2 mb-4" id="form-inst_bwu">
                <div class="col-md-3"><input type="text" id="f-ib-serie" class="form-control" placeholder="N¬∫ S√©rie"></div>
                <div class="col-md-2"><input type="date" id="f-ib-data" class="form-control"></div>
                <div class="col-md-3"><input type="text" id="f-ib-maq" class="form-control" placeholder="M√°quina"></div>
                <div class="col-md-2"><input type="text" id="f-ib-pos" class="form-control" placeholder="Posi√ß√£o"></div>
                <div class="col-md-2 d-flex gap-1">
                    <button class="btn btn-success w-100 btn-add" id="btn-save-inst_bwu" onclick="saveData('inst_bwu')">Salvar</button>
                    <button class="btn btn-secondary btn-sm d-none" id="btn-cancel-inst_bwu" onclick="cancelEdit()">‚úñ</button>
                </div>
            </div>
            <div class="header-actions">
                <input type="text" class="form-control w-50" placeholder="Pesquisar..." onkeyup="search(this, 't-ib')">
                <button class="btn btn-outline-secondary btn-sm" onclick="exportToCSV('inst_bwu')">üì• Exportar CSV</button>
            </div>
            <table class="table table-hover" id="t-ib">
                <thead><tr><th>S√©rie</th><th>Data</th><th>M√°quina</th><th>Posi√ß√£o</th><th>A√ß√µes</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="tab-rem-bwu">
            <div class="row g-2 mb-4" id="form-rem_bwu">
                <div class="col-md-2"><input type="text" id="f-rb-serie" class="form-control" placeholder="N¬∫ S√©rie"></div>
                <div class="col-md-2"><input type="date" id="f-rb-data" class="form-control"></div>
                <div class="col-md-2"><input type="text" id="f-rb-maq" class="form-control" placeholder="M√°quina"></div>
                <div class="col-md-2"><input type="text" id="f-rb-pos" class="form-control" placeholder="Posi√ß√£o"></div>
                <div class="col-md-2"><input type="text" id="f-rb-falha" class="form-control" placeholder="Falha"></div>
                <div class="col-md-2 d-flex gap-1">
                    <button class="btn btn-success w-100 btn-add" id="btn-save-rem_bwu" onclick="saveData('rem_bwu')">Salvar</button>
                    <button class="btn btn-secondary btn-sm d-none" id="btn-cancel-rem_bwu" onclick="cancelEdit()">‚úñ</button>
                </div>
            </div>
            <div class="header-actions">
                <input type="text" class="form-control w-50" placeholder="Pesquisar..." onkeyup="search(this, 't-rb')">
                <button class="btn btn-outline-secondary btn-sm" onclick="exportToCSV('rem_bwu')">üì• Exportar CSV</button>
            </div>
            <table class="table table-hover" id="t-rb">
                <thead><tr><th>S√©rie</th><th>Data</th><th>M√°quina</th><th>Posi√ß√£o</th><th>Falha</th><th>A√ß√µes</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="tab-inst-carretas">
            <div class="row g-2 mb-4" id="form-inst_carretas">
                <div class="col-md-3"><input type="text" id="f-ic-carreta" class="form-control" placeholder="Carreta"></div>
                <div class="col-md-2"><input type="date" id="f-ic-data" class="form-control"></div>
                <div class="col-md-3"><input type="text" id="f-ic-maq" class="form-control" placeholder="M√°quina"></div>
                <div class="col-md-2"><input type="text" id="f-ic-pos" class="form-control" placeholder="Posi√ß√£o"></div>
                <div class="col-md-2 d-flex gap-1">
                    <button class="btn btn-success w-100 btn-add" id="btn-save-inst_carretas" onclick="saveData('inst_carretas')">Salvar</button>
                    <button class="btn btn-secondary btn-sm d-none" id="btn-cancel-inst_carretas" onclick="cancelEdit()">‚úñ</button>
                </div>
            </div>
            <div class="header-actions">
                <input type="text" class="form-control w-50" placeholder="Pesquisar..." onkeyup="search(this, 't-ic')">
                <button class="btn btn-outline-secondary btn-sm" onclick="exportToCSV('inst_carretas')">üì• Exportar CSV</button>
            </div>
            <table class="table table-hover" id="t-ic">
                <thead><tr><th>Carreta</th><th>Data</th><th>M√°quina</th><th>Posi√ß√£o</th><th>A√ß√µes</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="tab-rem-carretas">
            <div class="row g-2 mb-4" id="form-rem_carretas">
                <div class="col-md-2"><input type="text" id="f-rc-carreta" class="form-control" placeholder="Carreta"></div>
                <div class="col-md-2"><input type="date" id="f-rc-data" class="form-control"></div>
                <div class="col-md-2"><input type="text" id="f-rc-maq" class="form-control" placeholder="M√°quina"></div>
                <div class="col-md-2"><input type="text" id="f-rc-pos" class="form-control" placeholder="Posi√ß√£o"></div>
                <div class="col-md-2"><input type="text" id="f-rc-falha" class="form-control" placeholder="Falha"></div>
                <div class="col-md-2 d-flex gap-1">
                    <button class="btn btn-success w-100 btn-add" id="btn-save-rem_carretas" onclick="saveData('rem_carretas')">Salvar</button>
                    <button class="btn btn-secondary btn-sm d-none" id="btn-cancel-rem_carretas" onclick="cancelEdit()">‚úñ</button>
                </div>
            </div>
            <div class="header-actions">
                <input type="text" class="form-control w-50" placeholder="Pesquisar..." onkeyup="search(this, 't-rc')">
                <button class="btn btn-outline-secondary btn-sm" onclick="exportToCSV('rem_carretas')">üì• Exportar CSV</button>
            </div>
            <table class="table table-hover" id="t-rc">
                <thead><tr><th>Carreta</th><th>Data</th><th>M√°quina</th><th>Posi√ß√£o</th><th>Falha</th><th>A√ß√µes</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA9yZPurd9lGJjZJghUohiauTBTxPWD2Oc",
        authDomain: "control-bwu-car.firebaseapp.com",
        projectId: "control-bwu-car",
        storageBucket: "control-bwu-car.firebasestorage.app",
        messagingSenderId: "23112503310",
        appId: "1:23112503310:web:57831fb5ffade6ef6e6c5f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Controle de estado da edi√ß√£o
    let editMode = { active: false, id: null, type: null };

    const fieldMapping = {
        'inst_bwu': ['f-ib-serie', 'f-ib-data', 'f-ib-maq', 'f-ib-pos'],
        'rem_bwu': ['f-rb-serie', 'f-rb-data', 'f-rb-maq', 'f-rb-pos', 'f-rb-falha'],
        'inst_carretas': ['f-ic-carreta', 'f-ic-data', 'f-ic-maq', 'f-ic-pos'],
        'rem_carretas': ['f-rc-carreta', 'f-rc-data', 'f-rc-maq', 'f-rc-pos', 'f-rc-falha']
    };

    // --- AUTENTICA√á√ÉO ---
    document.getElementById('btn-login').addEventListener('click', () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        signInWithEmailAndPassword(auth, email, pass).catch(err => alert("Erro: " + err.message));
    });
    document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));
    onAuthStateChanged(auth, user => {
        if (user) {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('user-display').innerText = user.email;
            initRealtimeSync();
        } else {
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('app-content').style.display = 'none';
        }
    });

    // --- SALVAR OU ATUALIZAR DADOS ---
    window.saveData = async (type) => {
        const ids = fieldMapping[type];
        let hasError = false;
        let payload = { timestamp: Date.now() };

        ids.forEach(id => {
            const el = document.getElementById(id);
            if (!el.value.trim()) { el.classList.add('is-invalid'); hasError = true; }
            else {
                el.classList.remove('is-invalid');
                const key = id.split('-').pop();
                payload[key === 'maq' ? 'maquina' : (key === 'pos' ? 'posicao' : key)] = el.value;
            }
        });

        if (hasError) return alert("Preencha todos os campos!");

        try {
            if (editMode.active && editMode.type === type) {
                // MODO EDI√á√ÉO: Atualiza documento existente
                await updateDoc(doc(db, type, editMode.id), payload);
                alert("Registro atualizado com sucesso!");
                cancelEdit();
            } else {
                // MODO NOVO: Cria novo documento
                await addDoc(collection(db, type), payload);
                ids.forEach((id, i) => { const el = document.getElementById(id); el.value = ""; if(i===0) el.focus(); });
            }
        } catch (e) { alert("Erro: " + e.message); }
    };

    // --- FUN√á√ÉO PARA ATIVAR EDI√á√ÉO ---
    window.prepareEdit = (type, id, dataJson) => {
        const data = JSON.parse(decodeURIComponent(dataJson));
        editMode = { active: true, id: id, type: type };

        // Preencher campos
        const ids = fieldMapping[type];
        ids.forEach(fieldId => {
            const key = fieldId.split('-').pop();
            const apiKey = key === 'maq' ? 'maquina' : (key === 'pos' ? 'posicao' : key);
            document.getElementById(fieldId).value = data[apiKey] || "";
            document.getElementById(fieldId).classList.add('editing-mode');
        });

        // Mudar visual do bot√£o
        document.getElementById(`btn-save-${type}`).innerText = "Atualizar";
        document.getElementById(`btn-save-${type}`).classList.replace('btn-success', 'btn-warning');
        document.getElementById(`btn-cancel-${type}`).classList.remove('d-none');

        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // --- CANCELAR EDI√á√ÉO ---
    window.cancelEdit = () => {
        if (!editMode.type) return;
        const type = editMode.type;
        const ids = fieldMapping[type];

        ids.forEach(id => {
            document.getElementById(id).value = "";
            document.getElementById(id).classList.remove('editing-mode', 'is-invalid');
        });

        document.getElementById(`btn-save-${type}`).innerText = "Salvar";
        document.getElementById(`btn-save-${type}`).classList.replace('btn-warning', 'btn-success');
        document.getElementById(`btn-cancel-${type}`).classList.add('d-none');

        editMode = { active: false, id: null, type: null };
    };

    // --- SINCRONIZA√á√ÉO EM TEMPO REAL ---
    function initRealtimeSync() {
        const tables = [
            { id: 'inst_bwu', table: 't-ib' },
            { id: 'rem_bwu', table: 't-rb' },
            { id: 'inst_carretas', table: 't-ic' },
            { id: 'rem_carretas', table: 't-rc' }
        ];

        tables.forEach(t => {
            onSnapshot(query(collection(db, t.id), orderBy("timestamp", "desc")), (snapshot) => {
                const tbody = document.querySelector(`#${t.table} tbody`);
                tbody.innerHTML = "";
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const dataString = encodeURIComponent(JSON.stringify(data));
                    const row = document.createElement('tr');

                    let html = `<td>${data.serie || data.carreta}</td><td>${data.data}</td><td>${data.maquina}</td><td>${data.posicao}</td>`;
                    if(t.id.includes('rem')) html += `<td>${data.falha || '-'}</td>`;

                    html += `<td class="d-flex gap-1">
                        <button class="btn btn-primary btn-sm" onclick="prepareEdit('${t.id}', '${docSnap.id}', '${dataString}')">Editar</button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteItem('${t.id}', '${docSnap.id}')">Excluir</button>
                    </td>`;

                    row.innerHTML = html;
                    tbody.appendChild(row);
                });
            });
        });
    }

    // --- OUTRAS FUN√á√ïES (EXCLUIR, PESQUISA, CSV) ---
    window.deleteItem = async (coll, id) => { if(confirm("Excluir definitivamente?")) await deleteDoc(doc(db, coll, id)); };

    window.search = (input, tableId) => {
        const filter = input.value.toLowerCase();
        document.querySelectorAll(`#${tableId} tbody tr`).forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
        });
    };

    window.exportToCSV = async (type) => {
        const querySnapshot = await getDocs(query(collection(db, type), orderBy("timestamp", "desc")));
        if (querySnapshot.empty) return alert("Vazio.");
        let csv = "\uFEFF" + (type.includes('bwu') ? "S√©rie" : "Carreta") + ";Data;M√°quina;Posi√ß√£o" + (type.includes('rem') ? ";Falha\n" : "\n");
        querySnapshot.forEach(doc => {
            const d = doc.data();
            let row = `${d.serie || d.carreta};${d.data};${d.maquina};${d.posicao}`;
            if(type.includes('rem')) row += `;${d.falha || ""}`;
            csv += row + "\n";
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `relatorio_${type}.csv`;
        link.click();
    };
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>